#
# !!! Build workflow, generated by nmk-github plugin, don't edit !!!
#
name: Build
on: push
jobs:
    # Only on branch push
    tests:
        name: Build and Test - Python ${{ matrix.version }} - ${{ matrix.os }}
        if: github.event_name == 'push' && !startsWith(github.event.ref, 'refs/tags')
        strategy:
            fail-fast: false
            matrix:
                os:
                    - ubuntu-latest
                    - windows-latest
                version:
                    - "3.10"
        runs-on: ${{ matrix.os }}
        steps:
            # Checkout and fetch tags
            - name: Checkout
              uses: actions/checkout@v6.0.1
              with:
                  fetch-depth: 0
                  fetch-tags: true
                  submodules: true

            # Setup python
            - name: Set up Python ${{ matrix.version }}
              uses: actions/setup-python@v6.1.0
              with:
                  python-version: ${{ matrix.version }}

            # Trigger build and tests + archive output
            - name: Build and tests
              id: build_n_tests
              shell: bash
              run: ./buildenv.sh run nmk build tests
              continue-on-error: true
            - name: Archive build output
              uses: actions/upload-artifact@v6.0.0
              with:
                  name: Output-${{ matrix.os }}-${{ matrix.version }}
                  path: |
                    .nmk/nmk.log*
                    out/
            - name: Build Failed!
              if: steps.build_n_tests.outcome == 'failure'
              uses: actions/github-script@v8.0.0
              with:
                script: |
                    core.setFailed('Build step failed')

